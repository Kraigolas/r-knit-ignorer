#!/bin/bash
#
# Unstage all .html and .pdf files that share the same basename as a .Rmd file
# which resides in the same directory, and add said files to the .gitignore 
echo running precommit...

# Remove the spaces from the basename of a file in a filepath,
# but leave directory spaces intact  
function file_strip_space(){
    basename="${1##*/}"
    pathname="${1%/*}"
	if [ "${#basename}" == "${#1}" ]; then 
	    echo ${basename// /-}
	else
	    echo "${pathname}/${basename// /-}"
	fi
}



function change_ext(){
        echo "${1%.*}.$2"
}

stagedFiles=$(git diff --staged --name-only --diff-filter=A "*.[rR][mM][dD]") 
echo staged: ${stagedFiles}
IFS=$'\n'
for file in $stagedFiles; do 
        filename="${file%.*}"
        filename=$(file_strip_space $filename)
        git restore --staged "$filename.pdf" 2>/dev/null 
        if [[ $? == 0 ]]; then 
            echo ignore-knit: Unstaging $filename.pdf 
		fi 
	git restore --staged "$filename.html" 2>/dev/null 
	    if [[ $? == 0 ]]; then 
	        echo ignore-knit: Unstaging $filename.html
		fi 
	echo ignore-knit: Adding $filename.pdf and $filename.html to .gitignore
        echo "
# generated by r-knit-ignorer
$filename.pdf
$filename.html" >> .gitignore 
done 

git add .gitignore 
echo ignore-knit: Staging .gitignore to be committed 
